<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, Arial, sans-serif;
            background: #ffffff;
            padding: 20px;
            line-height: 1.6;
            color: #222;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            background: #f9f9f9;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5dc;
            border-radius: 12px;
            color: #333;
            border: 2px solid #daa520;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .education-section {
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%);
            border-radius: 12px;
            border-left: 4px solid #9f7aea;
        }

        .education-section h3 {
            color: #553c9a;
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .education-section p {
            color: #4a5568;
            margin-bottom: 12px;
        }

        .consultation-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .mode-card {
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mode-card.simple {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .mode-card.advanced {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .mode-card.active {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .mode-card h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .mode-card p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .element-calculator {
            display: none;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            border: 2px solid #6366f1;
        }

        .element-calculator h4 {
            color: #3730a3;
            margin-bottom: 12px;
        }

        .calculated-element {
            display: none;
            padding: 16px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 4px solid #059669;
        }

        .calculated-element h4 {
            color: #064e3b;
            margin-bottom: 8px;
        }

        .calculated-element p {
            color: #065f46;
        }

        .element-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%);
            border-radius: 12px;
        }

        .element-card {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .element-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .element-name {
            font-weight: 600;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .element-select {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
        }

        .element-select option {
            background: white;
            color: #333;
        }

        .birth-date-required {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border-color: #fc8181;
        }

        .submit-btn {
            background: #f5f5dc;
            color: #333;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            background: #daa520;
            color: white;
            box-shadow: 0 8px 25px rgba(218, 165, 32, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            transform: none;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .output-section {
            margin-top: 24px;
        }

        .response-box {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 16px;
            white-space: pre-wrap;
            min-height: 80px;
            color: #2d3748;
            line-height: 1.8;
            border-left: 4px solid #ed8936;
        }

        .response-box.empty {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
            color: #4a5568;
            font-style: italic;
            border-left: 4px solid #a0aec0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .error {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border: 2px solid #fc8181;
            color: #c53030;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }

            .element-info {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .consultation-modes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® å°ˆæ¥­é¢¨æ°´é¡§å•</h1>
            <p>è³‡æ·±é¢¨æ°´å¸«ã€Œç„æ©Ÿè€å¸«ã€ï½œåŸºæ–¼å‚³çµ±é¢¨æ°´å­¸èˆ‡äº”è¡ŒåŸç†çš„æ™ºæ…§è«®è©¢</p>
        </div>

        <div class="education-section">
            <h3>ğŸŒŸ ä»€éº¼æ˜¯äº”è¡Œå…«å­—ï¼Ÿ</h3>
            <p><strong>äº”è¡Œ</strong>æ˜¯ä¸­åœ‹å¤ä»£å“²å­¸çš„æ ¸å¿ƒæ¦‚å¿µï¼ŒåŒ…å«æœ¨ã€ç«ã€åœŸã€é‡‘ã€æ°´äº”ç¨®åŸºæœ¬å…ƒç´ ï¼Œä»£è¡¨ä¸åŒçš„èƒ½é‡ç‰¹è³ªå’Œç”Ÿå‘½é€±æœŸã€‚</p>
            <p><strong>å…«å­—</strong>æ˜¯æ ¹æ“šä½ çš„å‡ºç”Ÿå¹´æœˆæ—¥æ™‚æ¨ç®—å‡ºçš„å››çµ„å¤©å¹²åœ°æ”¯ï¼Œåæ˜ ä½ èˆ‡ç”Ÿä¿±ä¾†çš„äº”è¡Œç‰¹è³ªå’Œå‘½é‹å‚¾å‘ã€‚</p>
            <p>ğŸ’¡ <strong>åˆ¥æ“”å¿ƒä¸æ‡‚å…«å­—ï¼</strong>åªéœ€æä¾›å‡ºç”Ÿæ—¥æœŸï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºä½ æ¨ç®—å°ˆå±¬çš„äº”è¡Œç‰¹è³ªã€‚</p>
        </div>

        <div class="consultation-modes">
            <div class="mode-card simple active" onclick="switchMode('simple')">
                <h4>ğŸŒ¸ ç°¡æ˜“æ¨¡å¼</h4>
                <p>æä¾›å‡ºç”Ÿæ—¥æœŸï¼Œè‡ªå‹•æ¨ç®—äº”è¡Œ</p>
            </div>
            <div class="mode-card advanced" onclick="switchMode('advanced')">
                <h4>ğŸ”® é€²éšæ¨¡å¼</h4>
                <p>å·²çŸ¥äº”è¡Œå…«å­—ï¼Œç›´æ¥é¸æ“‡å…ƒç´ </p>
            </div>
        </div>

        <div class="element-calculator" id="elementCalculator">
            <h4>ğŸ§® äº”è¡Œå…«å­—æ¨ç®—</h4>
            <p>è«‹æä¾›æ‚¨çš„å‡ºç”Ÿæ—¥æœŸï¼Œç³»çµ±å°‡ç‚ºæ‚¨æ¨ç®—å°ˆå±¬çš„äº”è¡Œç‰¹è³ªï¼š</p>
            <div class="form-group">
                <label for="calcBirthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" id="calcBirthDate" class="birth-date-required" required>
            </div>
            <button type="button" class="calculate-btn" onclick="calculateElements()">
                ğŸ” æ¨ç®—æˆ‘çš„äº”è¡Œå…«å­—
            </button>
        </div>

        <div class="calculated-element" id="calculatedElement">
            <h4>ğŸ¯ æ‚¨çš„äº”è¡Œç‰¹è³ª</h4>
            <div id="elementResult"></div>
        </div>

        <div class="element-info">
            <div class="element-card">
                <div class="element-emoji">ğŸŒ²</div>
                <div class="element-name">æœ¨ - æ˜¥å­£æ±æ–¹</div>
            </div>
            <div class="element-card">
                <div class="element-emoji">ğŸ”¥</div>
                <div class="element-name">ç« - å¤å­£å—æ–¹</div>
            </div>
            <div class="element-card">
                <div class="element-emoji">ğŸ”ï¸</div>
                <div class="element-name">åœŸ - é•·å¤ä¸­å¤®</div>
            </div>
            <div class="element-card">
                <div class="element-emoji">âš”ï¸</div>
                <div class="element-name">é‡‘ - ç§‹å­£è¥¿æ–¹</div>
            </div>
            <div class="element-card">
                <div class="element-emoji">ğŸ’§</div>
                <div class="element-name">æ°´ - å†¬å­£åŒ—æ–¹</div>
            </div>
        </div>

        <form id="fengshuiForm" onsubmit="event.preventDefault(); send();">
            <div class="form-group">
                <label for="userName">ä½ çš„åå­—</label>
                <input type="text" id="userName" value="æ±‚å•è€…" required>
            </div>

            <div class="form-group" id="elementSelectGroup">
                <label for="userElement">ä½ çš„ä¸»è¦äº”è¡Œå…ƒç´  (é€²éšæ¨¡å¼)</label>
                <select id="userElement" class="element-select">
                    <option value="">è«‹é¸æ“‡ä½ çš„äº”è¡Œå…ƒç´ </option>
                    <option value="æœ¨">ğŸŒ² æœ¨ - æˆé•·å‰µæ–° (æ˜¥å­£æ±æ–¹)</option>
                    <option value="ç«">ğŸ”¥ ç« - ç†±æƒ…æ´»èº (å¤å­£å—æ–¹)</option>
                    <option value="åœŸ">ğŸ”ï¸ åœŸ - ç©©å®šåŒ…å®¹ (é•·å¤ä¸­å¤®)</option>
                    <option value="é‡‘">âš”ï¸ é‡‘ - æ”¶æ–‚æœæ±º (ç§‹å­£è¥¿æ–¹)</option>
                    <option value="æ°´">ğŸ’§ æ°´ - æ™ºæ…§éˆå‹• (å†¬å­£åŒ—æ–¹)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="questionCategory">å•é¡Œé¡å‹</label>
                <select id="questionCategory">
                    <option value="">ç¶œåˆè«®è©¢</option>
                    <option value="æ„Ÿæƒ…">ğŸ’• æ„Ÿæƒ…å•é¡Œ</option>
                    <option value="äº‹æ¥­">ğŸ’¼ äº‹æ¥­ç™¼å±•</option>
                    <option value="å¥åº·">ğŸƒ å¥åº·ç‹€æ³</option>
                    <option value="è²¡é‹">ğŸ’° è²¡é‹ç‹€æ³</option>
                    <option value="å±…å®¶ç’°å¢ƒ">ğŸ  å±…å®¶ç’°å¢ƒ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="userQuestion">ä½ çš„å•é¡Œ</label>
                <textarea id="userQuestion" placeholder="è«‹è©³ç´°æè¿°ä½ çš„å…·é«”æƒ…æ³ï¼Œä¾‹å¦‚ï¼šæˆ‘çš„è¾¦å…¬å®¤æœåŒ—ï¼Œæœ€è¿‘å·¥ä½œä¸é †ï¼Œæƒ³äº†è§£å¦‚ä½•èª¿æ•´é¢¨æ°´ä¾†æ”¹å–„é‹å‹¢..." rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="timeframe">è«®è©¢æ™‚é–“ç¯„åœ</label>
                <select id="timeframe">
                    <option value="ä»Šå¤©">ä»Šå¤©</option>
                    <option value="æœ¬é€±">æœ¬é€±</option>
                    <option value="æœ¬æœˆ">æœ¬æœˆ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ (ç°¡æ˜“æ¨¡å¼å¿…å¡«)</label>
                <input type="date" id="birthDate" class="birth-date-required">
            </div>

            <div class="form-group">
                <label for="birthTime">å‡ºç”Ÿæ™‚é–“ (å¯é¸ï¼Œç”¨æ–¼æ›´ç²¾ç¢ºå…«å­—)</label>
                <input type="time" id="birthTime" placeholder="HH:MM">
            </div>

            <div class="form-group">
                <label for="homeDirection">å±…å®¶æœå‘ (å¯é¸)</label>
                <select id="homeDirection">
                    <option value="">è«‹é¸æ“‡æœå‘</option>
                    <option value="æ±æ–¹">ğŸŒ… æ±æ–¹ (æœ¨å…ƒç´ )</option>
                    <option value="æ±å—">ğŸŒ¤ï¸ æ±å— (æœ¨å…ƒç´ )</option>
                    <option value="å—æ–¹">â˜€ï¸ å—æ–¹ (ç«å…ƒç´ )</option>
                    <option value="è¥¿å—">ğŸŒ† è¥¿å— (åœŸå…ƒç´ )</option>
                    <option value="è¥¿æ–¹">ğŸŒ‡ è¥¿æ–¹ (é‡‘å…ƒç´ )</option>
                    <option value="è¥¿åŒ—">ğŸŒƒ è¥¿åŒ— (é‡‘å…ƒç´ )</option>
                    <option value="åŒ—æ–¹">ğŸŒŒ åŒ—æ–¹ (æ°´å…ƒç´ )</option>
                    <option value="æ±åŒ—">ğŸ”ï¸ æ±åŒ— (åœŸå…ƒç´ )</option>
                </select>
            </div>

            <div class="form-group">
                <label for="mood">ç›®å‰å¿ƒæƒ…ç‹€æ…‹ (å¯é¸)</label>
                <input type="text" id="mood" placeholder="ä¾‹å¦‚ï¼šç„¦æ…®ã€èˆˆå¥®ã€å›°æƒ‘ã€å¹³éœ...">
            </div>

            <div class="form-group">
                <label for="partnerElement">ä¼´ä¾¶äº”è¡Œå…ƒç´  (æ„Ÿæƒ…å•é¡Œæ™‚å¯å¡«å¯«)</label>
                <select id="partnerElement">
                    <option value="">è«‹é¸æ“‡ä¼´ä¾¶çš„äº”è¡Œå…ƒç´ </option>
                    <option value="æœ¨">ğŸŒ² æœ¨ - æˆé•·å‰µæ–°</option>
                    <option value="ç«">ğŸ”¥ ç« - ç†±æƒ…æ´»èº</option>
                    <option value="åœŸ">ğŸ”ï¸ åœŸ - ç©©å®šåŒ…å®¹</option>
                    <option value="é‡‘">âš”ï¸ é‡‘ - æ”¶æ–‚æœæ±º</option>
                    <option value="æ°´">ğŸ’§ æ°´ - æ™ºæ…§éˆå‹•</option>
                </select>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                ğŸ® é–‹å§‹å°ˆæ¥­é¢¨æ°´è«®è©¢
            </button>
        </form>

        <div class="output-section">
            <div class="loading" id="loading">
                ğŸ® ç„æ©Ÿè€å¸«æ­£åœ¨ç‚ºä½ åˆ†æäº”è¡Œé‹å‹¢...
            </div>
            <div class="response-box empty" id="responseBox">
                æ­¡è¿ä¾†åˆ°å°ˆæ¥­é¢¨æ°´è«®è©¢ï¼<br><br>
                <strong>ğŸŒ¸ ç°¡æ˜“æ¨¡å¼ï¼š</strong>æä¾›å‡ºç”Ÿæ—¥æœŸï¼Œè‡ªå‹•æ¨ç®—äº”è¡Œç‰¹è³ª<br>
                <strong>ğŸ”® é€²éšæ¨¡å¼ï¼š</strong>å·²çŸ¥è‡ªå·±äº”è¡Œçš„æœ‹å‹å¯ç›´æ¥é¸æ“‡<br><br>
                ç„æ©Ÿè€å¸«å°‡æ ¹æ“šæ‚¨çš„äº”è¡Œç‰¹è³ªç‚ºæ‚¨æä¾›å°ˆæ¥­é¢¨æ°´æŒ‡å°
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'simple';
        let calculatedUserElement = null;

        function switchMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.mode-card.${mode}`).classList.add('active');
            
            const elementSelectGroup = document.getElementById('elementSelectGroup');
            const elementCalculator = document.getElementById('elementCalculator');
            const birthDateField = document.getElementById('birthDate');
            
            if (mode === 'simple') {
                elementSelectGroup.style.display = 'none';
                elementCalculator.style.display = 'block';
                birthDateField.required = true;
                birthDateField.classList.add('birth-date-required');
            } else {
                elementSelectGroup.style.display = 'block';
                elementCalculator.style.display = 'none';
                birthDateField.required = false;
                birthDateField.classList.remove('birth-date-required');
                // Hide calculated element result in advanced mode
                document.getElementById('calculatedElement').style.display = 'none';
            }
        }

        async function calculateElements() {
            const birthDate = document.getElementById('calcBirthDate').value;
            if (!birthDate) {
                alert('è«‹å…ˆé¸æ“‡å‡ºç”Ÿæ—¥æœŸï¼');
                return;
            }

            try {
                const response = await fetch('/calculate-elements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ birth_date: birthDate })
                });

                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const elements = data.elements;
                const descriptions = data.element_descriptions;
                
                calculatedUserElement = elements.primary;
                
                const resultDiv = document.getElementById('elementResult');
                const primary = descriptions[elements.primary];
                const secondary = descriptions[elements.secondary];
                
                resultDiv.innerHTML = `
                    <p><strong>ä¸»è¦äº”è¡Œï¼š${primary.name}ï¼ˆ${primary.traits}ï¼‰</strong></p>
                    <p>æ–¹ä½ï¼š${primary.direction} | å­£ç¯€ï¼š${primary.season} | é¡è‰²ï¼š${primary.color}</p>
                    <p><strong>è¼”åŠ©äº”è¡Œï¼š${secondary.name}ï¼ˆ${secondary.traits}ï¼‰</strong></p>
                    <p class="explanation" style="margin-top:12px; font-style:italic; color:#065f46;">${elements.explanation}</p>
                `;
                
                document.getElementById('calculatedElement').style.display = 'block';
                
                // Auto-fill birth date in main form
                document.getElementById('birthDate').value = birthDate;
                
            } catch (error) {
                console.error('è¨ˆç®—äº”è¡Œå¤±æ•—:', error);
                alert('è¨ˆç®—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function send() {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const responseBox = document.getElementById('responseBox');
            
            // å–å¾—è¡¨å–®è³‡æ–™
            const userName = document.getElementById('userName').value.trim();
            const userQuestion = document.getElementById('userQuestion').value.trim();
            const questionCategory = document.getElementById('questionCategory').value;
            const timeframe = document.getElementById('timeframe').value;
            const homeDirection = document.getElementById('homeDirection').value;
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            const mood = document.getElementById('mood').value.trim();
            const partnerElement = document.getElementById('partnerElement').value;
            
            let userElement = null;
            
            if (currentMode === 'advanced') {
                userElement = document.getElementById('userElement').value;
                if (!userElement) {
                    alert('é€²éšæ¨¡å¼è«‹é¸æ“‡äº”è¡Œå…ƒç´ ï¼');
                    return;
                }
            } else {
                // Simple mode - use calculated element or require birth date
                if (calculatedUserElement) {
                    userElement = calculatedUserElement;
                } else if (birthDate) {
                    userElement = null; // Let backend calculate
                } else {
                    alert('ç°¡æ˜“æ¨¡å¼è«‹æä¾›å‡ºç”Ÿæ—¥æœŸï¼');
                    return;
                }
            }
            
            // é©—è­‰è¼¸å…¥
            if (!userName || !userQuestion) {
                alert('è«‹å¡«å¯«å§“åå’Œå•é¡Œï¼');
                return;
            }
            
            // è¨­å®šè¼‰å…¥ç‹€æ…‹
            submitBtn.disabled = true;
            submitBtn.textContent = 'ğŸ® ç„æ©Ÿè€å¸«è«®è©¢ä¸­...';
            loading.style.display = 'block';
            loading.textContent = 'ğŸŒŸ æ­£åœ¨çµåˆæ‚¨çš„äº”è¡Œç‰¹è³ªé€²è¡Œæ·±åº¦é¢¨æ°´åˆ†æ...';
            responseBox.className = 'response-box empty';
            responseBox.textContent = '';
            
            // æº–å‚™è«‹æ±‚è³‡æ–™
            const requestData = {
                user: userName,
                element: userElement,
                question: userQuestion,
                category: questionCategory || null,
                timeframe: timeframe,
                home_direction: homeDirection || null,
                birth_date: birthDate || null,
                birth_time: birthTime || null,
                mood: mood || null,
                partner_element: partnerElement || null
            };
            
            try {
                // ç™¼é€è«‹æ±‚åˆ°å¾Œç«¯API
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // é¡¯ç¤ºå¢å¼·çš„å›æ‡‰å…§å®¹
                responseBox.className = 'response-box';
                
                let displayText = data.reply || 'æŠ±æ­‰ï¼Œç„¡æ³•å–å¾—é¢¨æ°´å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                
                // æ·»åŠ é¢¨æ°´å­¸æ´å¯Ÿ
                if (data.fengshui_insight) {
                    displayText += '\n\nğŸŒŸ é¢¨æ°´å­¸æ´å¯Ÿï¼š\n';
                    displayText += `ğŸ® ç•¶æ—¥äº”è¡Œï¼š${data.fengshui_insight.daily_element_influence}\n`;
                    displayText += `ğŸ‚ å­£ç¯€èƒ½é‡ï¼š${data.fengshui_insight.seasonal_energy}\n`;
                    displayText += `âš¡ å…ƒç´ æŒ‡å°ï¼š${data.fengshui_insight.element_guidance}\n`;
                    displayText += `ğŸ§­ å…«å¦æŒ‡å¼•ï¼š${data.fengshui_insight.bagua_guidance}`;
                }
                
                // æ·»åŠ æ™‚æ©ŸæŒ‡å°
                if (data.timing_advice) {
                    displayText += '\n\nâ° æœ€ä½³æ™‚æ©Ÿï¼š\n' + data.timing_advice;
                }
                
                // æ·»åŠ å¯¦ç”¨å»ºè­°
                if (data.tips && data.tips.length > 0) {
                    displayText += '\n\nğŸ’ å°ˆæ¥­å»ºè­°ï¼š\n';
                    data.tips.forEach((tip, index) => {
                        displayText += `${index + 1}. ${tip}\n`;
                    });
                }
                
                // æ·»åŠ æ­£é¢è‚¯å®šèª
                if (data.affirmation) {
                    displayText += '\nâœ¨ èƒ½é‡ç¥ç¦ï¼š\n' + data.affirmation;
                }
                
                // æ·»åŠ å¹¸é‹å…ƒç´ 
                if (data.lucky_elements) {
                    displayText += '\n\nğŸ€ ä»Šæ—¥å¹¸é‹å…ƒç´ ï¼š\n';
                    displayText += `ğŸ¨ å¹¸é‹è‰²å½©ï¼š${data.lucky_elements.color}\n`;
                    displayText += `ğŸ”¢ å¹¸é‹æ•¸å­—ï¼š${data.lucky_elements.number}\n`;
                    displayText += `ğŸ§­ å¹¸é‹æ–¹ä½ï¼š${data.lucky_elements.direction}\n`;
                    displayText += `â° å¹¸é‹æ™‚æ®µï¼š${data.lucky_elements.time}\n`;
                    displayText += `ğŸŒ¸ å°æ‡‰å­£ç¯€ï¼š${data.lucky_elements.season}`;
                }
                
                // æ·»åŠ äº”è¡Œå’Œè«§åˆ†æ
                if (data.harmony_score && partnerElement) {
                    displayText += '\n\nğŸ’• äº”è¡Œå’Œè«§åˆ†æï¼š\n';
                    displayText += `èˆ‡${partnerElement}å…ƒç´ çš„å’Œè«§åº¦ï¼š${data.harmony_score}%`;
                    
                    let harmonyLevel = '';
                    if (data.harmony_score >= 80) harmonyLevel = 'âœ¨ å¤©ä½œä¹‹åˆ';
                    else if (data.harmony_score >= 65) harmonyLevel = 'ğŸ’– ç›¸ç”Ÿå’Œè«§';
                    else if (data.harmony_score >= 50) harmonyLevel = 'ğŸ’« å¹³è¡¡ç©©å®š';
                    else harmonyLevel = 'ğŸ’ª éœ€è¦èª¿å’Œ';
                    
                    displayText += ` (${harmonyLevel})`;
                }
                
                responseBox.textContent = displayText;
                
            } catch (error) {
                console.error('è«‹æ±‚å¤±æ•—:', error);
                responseBox.className = 'response-box error';
                responseBox.textContent = `é€£ç·šéŒ¯èª¤ï¼š${error.message}\n\nè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦æ­£åœ¨é‹è¡Œï¼Œä¸¦é‡æ–°å˜—è©¦ã€‚`;
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ® é–‹å§‹å°ˆæ¥­é¢¨æ°´è«®è©¢';
                loading.style.display = 'none';
            }
        }
        
        // æŒ‰ Enter éµæäº¤ï¼ˆåœ¨ textarea ä¸­æŒ‰ Shift+Enter æ›è¡Œï¼‰
        document.getElementById('userQuestion').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        });
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç°¡æ˜“æ¨¡å¼
        window.addEventListener('load', function() {
            switchMode('simple');
            document.getElementById('userQuestion').focus();
        });
    </script>
</body>
</html>